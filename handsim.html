<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yu-Gi-Oh! Hand simulator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #121212;
      color: #e0e0e0;
      transition: background-color 0.3s, color 0.3s;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      transition: background 0.3s;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    input[type="file"] {
      display: block;
      margin: 0 auto 20px auto;
    }
    .row {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }
    .left-pane, .right-pane {
      background: #2e2e2e;
      padding: 10px;
      border-radius: 6px;
    }
    .left-pane {
      flex: 2;
      /* Enough height to show 40–60 cards without scrolling */
      min-height: 600px;
    }
    .right-pane {
      flex: 1;
    }
    /* Main deck header */
    .deck-header {
      font-size: 1.2em;
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
    }
    .card-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .card-list li {
      padding: 4px 0;
      border-bottom: 1px solid #444;
    }
    .card-list li:last-child {
      border-bottom: none;
    }
    /* Good hand specification styles */
    .good-hand-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }
    .good-hand-row input[type="text"] {
      flex: 1;
      padding: 5px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #2e2e2e;
      color: #e0e0e0;
    }
    .good-hand-buttons {
      display: flex;
      gap: 5px;
    }
    .good-hand-buttons button {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #555;
      color: #e0e0e0;
      transition: background 0.3s;
    }
    .good-hand-buttons button:hover {
      background-color: #777;
    }
    .right-pane h2 {
      margin-top: 0;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Yu-Gi-Oh! Hand simulator</h1>
    <input type="file" id="fileInput" accept=".ydk">
    <div class="row">
      <div class="left-pane" id="output">
        <!-- Main deck list will be inserted here -->
      </div>
      <div class="right-pane">
        <h2>Specify Good Hands</h2>
        <div id="goodHandsContainer">
          <!-- Good hand rows will be inserted here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Main deck parsing and display functions ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async function(event) {
        const text = event.target.result;
        // Parse the file for the main deck only.
        const mainDeck = parseYDK(text);
        if (mainDeck.length === 0) {
          document.getElementById('output').textContent = 'No cards found in the file.';
          return;
        }
        try {
          // Fetch card details for the main deck
          const cardMap = await fetchCardDetails(mainDeck);
          // Display the main deck list with grouped counts.
          displayMainDeck(mainDeck, cardMap);
        } catch (err) {
          document.getElementById('output').textContent = 'Error fetching card details: ' + err;
        }
      }
      reader.readAsText(file);
    });

    // Extract only the main deck card IDs from a .ydk file.
    function parseYDK(text) {
      const lines = text.split(/\r?\n/);
      const main = [];
      let currentSection = "main";
      for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        if (line.startsWith("#")) {
          currentSection = (line.toLowerCase() === "#main") ? "main" : "other";
          continue;
        }
        if (line.startsWith("!")) {
          currentSection = "other";
          continue;
        }
        if (!isNaN(line) && currentSection === "main") {
          main.push(line);
        }
      }
      return main;
    }

    // Fetch card details from the YGOPRODeck API.
    async function fetchCardDetails(ids) {
      const uniqueIds = Array.from(new Set(ids));
      const parameter = uniqueIds.join(",");
      const response = await fetch(`https://db.ygoprodeck.com/api/v7/cardinfo.php?utm_source=storm-access&misc=yes&id=${parameter}`);
      const payload = await response.json();
      const cardMap = new Map();
      for (const card of payload.data) {
        cardMap.set(String(card.id), card);
      }
      return cardMap;
    }

    // Display the main deck list with a header showing the card count and grouped counts per card.
    function displayMainDeck(deck, cardMap) {
      const output = document.getElementById('output');
      output.innerHTML = ''; // Clear previous content
      
      // Create header label "Main Deck (XX)"
      const header = document.createElement('div');
      header.className = 'deck-header';
      header.textContent = `Main Deck (${deck.length})`;
      output.appendChild(header);
      
      // Count the frequency for each card ID.
      const counts = {};
      deck.forEach(id => {
        counts[id] = (counts[id] || 0) + 1;
      });
      
      // Build the card list.
      const list = document.createElement('ul');
      list.className = 'card-list';
      for (const id in counts) {
        const count = counts[id];
        const card = cardMap.get(id);
        const li = document.createElement('li');
        li.textContent = `${count} - ${card ? card.name : `Unknown card (ID: ${id})`}`;
        list.appendChild(li);
      }
      output.appendChild(list);
    }

    // --- Good Hand Specification Functions ---
    // Create a new good-hand row.
    function createGoodHandRow(value = "") {
      const row = document.createElement('div');
      row.className = 'good-hand-row';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.placeholder = 'Enter good hand specification';
      input.value = value;
      
      const btnContainer = document.createElement('div');
      btnContainer.className = 'good-hand-buttons';
      
      const addBtn = document.createElement('button');
      addBtn.textContent = '+';
      addBtn.title = 'Add a new good hand specification row';
      addBtn.addEventListener('click', () => {
        // Insert a new row after the current row.
        const newRow = createGoodHandRow();
        row.parentNode.insertBefore(newRow, row.nextSibling);
      });
      
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '–';
      removeBtn.title = 'Remove this good hand specification row';
      removeBtn.addEventListener('click', () => {
        // Only remove if there's more than one row.
        const container = document.getElementById('goodHandsContainer');
        if (container.children.length > 1) {
          row.remove();
        } else {
          // If only one row remains, just clear its value.
          input.value = "";
        }
      });
      
      btnContainer.appendChild(addBtn);
      btnContainer.appendChild(removeBtn);
      
      row.appendChild(input);
      row.appendChild(btnContainer);
      return row;
    }

    // Initialize the good hand specification box with one row.
    function initGoodHands() {
      const container = document.getElementById('goodHandsContainer');
      container.innerHTML = "";
      container.appendChild(createGoodHandRow());
    }

    // Initialize good hand rows on page load.
    document.addEventListener('DOMContentLoaded', () => {
      initGoodHands();
    });
  </script>
</body>
</html>
